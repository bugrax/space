services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: saas_finder_postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=saas_finder
      - POSTGRES_PASSWORD=saas_finder_secret
      - POSTGRES_DB=saas_finder
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U saas_finder -d saas_finder"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis - Message Broker & Result Backend
  redis:
    image: redis:7-alpine
    container_name: saas_finder_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Celery Worker - Processes tasks
  celery_worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: saas_finder_worker
    command: celery -A saas_finder.celery_app worker --loglevel=info -Q default,twitter,scoring,maintenance
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://saas_finder:saas_finder_secret@postgres:5432/saas_finder
      - PYTHONPATH=/app
      - APIFY_API_TOKEN=${APIFY_API_TOKEN:-}
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Celery Beat - Scheduler
  celery_beat:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: saas_finder_beat
    command: celery -A saas_finder.celery_app beat --loglevel=info
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://saas_finder:saas_finder_secret@postgres:5432/saas_finder
      - PYTHONPATH=/app
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      celery_worker:
        condition: service_started
    restart: unless-stopped

  # Flower - Celery Monitoring
  flower:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: saas_finder_flower
    command: celery -A saas_finder.celery_app flower --port=5555
    ports:
      - "5555:5555"
    volumes:
      - .:/app
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://saas_finder:saas_finder_secret@postgres:5432/saas_finder
      - PYTHONPATH=/app
      - FLOWER_UNAUTHENTICATED_API=true
    env_file:
      - .env
    depends_on:
      - redis
      - celery_worker
    restart: unless-stopped

  # FastAPI Backend
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: saas_finder_api
    command: uvicorn saas_finder.api:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - ./config:/app/config
      - ./data:/app/data
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://saas_finder:saas_finder_secret@postgres:5432/saas_finder
      - PYTHONPATH=/app
      - TWITTER_ACCOUNTS_FILE=/app/config/accounts.txt
      - ENABLE_TWSCRAPE=true
      - ENABLE_APIFY=true
      - ENABLE_SCWEET=false
      - SCRAPE_INTERVAL_HOURS=4
      - MAX_TWEETS_PER_QUERY=100
      - RATE_LIMIT_DELAY=2.0
      - MIN_MRR_THRESHOLD=500
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Next.js Frontend
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8000
    container_name: saas_finder_web
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - api
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
